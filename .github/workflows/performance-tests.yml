name: Performance Tests

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/components/**'
      - 'src/lib/**'
      - 'src/app/**'
      - '.maestro/**'
      - 'package.json'
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test'
        required: true
        default: 'android'
        type: choice
        options:
          - android
          - ios
          - both

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  JAVA_VERSION: '17'
  MAESTRO_VERSION: '1.40.0'

jobs:
  # ============================================================================
  # Android Performance Tests
  # ============================================================================
  android-performance:
    name: Android Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' || github.event.inputs.platform == ''
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm-install

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Maestro
        run: |
          pnpm run install-maestro
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Build Android Release APK
        env:
          BUILD_TYPE: release
        run: |
          cd android
          ./gradlew assembleRelease
          cd ..

      - name: Start Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          profile: pixel_6a
          script: echo "Emulator started"

      - name: Install APK on Emulator
        run: |
          adb install android/app/build/outputs/apk/release/app-release.apk

      - name: Seed Test Database
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          # TODO: Create data seeding script
          # pnpm run test:seed-community --posts=1000 --images=mixed
          echo "Database seeding would happen here"

      - name: Start Perfetto Trace Collection
        env:
          PERFETTO_TRACE_PATH: perfetto-trace.pb
          PERFETTO_DURATION_MS: 30000
          APP_PACKAGE: com.growbro.app
        run: |
          chmod +x scripts/ci/perfetto-collector.sh
          ./scripts/ci/perfetto-collector.sh start

      - name: Run Maestro Performance Tests
        env:
          APP_ID: com.growbro.app
          BUILD_TYPE: release
          PLATFORM: android
          DEVICE_MODEL: Pixel 6a Emulator
          OS_VERSION: Android 13
          BUILD_HASH: ${{ github.sha }}
          DATASET_SIZE: 1000
        run: |
          maestro test .maestro/community/scroll-performance.yaml \
            --format junit \
            --output maestro-results/performance-results.xml

      - name: Run Memory Leak Detection Test
        env:
          APP_ID: com.growbro.app
          BUILD_TYPE: release
          PLATFORM: android
          DEVICE_MODEL: Pixel 6a Emulator
          OS_VERSION: Android 13
          BUILD_HASH: ${{ github.sha }}
          DATASET_SIZE: 1000
        run: |
          maestro test .maestro/performance/memory-scroll-test.yaml \
            --format junit \
            --output maestro-results/memory-test-results.xml

      - name: Stop Perfetto Trace Collection
        if: always()
        env:
          PERFETTO_TRACE_PATH: perfetto-trace.pb
        run: |
          ./scripts/ci/perfetto-collector.sh stop || true

      - name: Collect RN Performance Metrics
        if: always()
        run: |
          # RN Performance JSON would be generated by the app
          # and pulled from device storage
          adb pull /sdcard/Android/data/com.growbro.app/files/performance.json rn-performance.json || true

      - name: Validate Performance Budgets
        if: always()
        env:
          BUILD_TYPE: release
          PLATFORM: android
          DEVICE_MODEL: Pixel 6a Emulator
          OS_VERSION: Android 13
          BUILD_HASH: ${{ github.sha }}
          DATASET_SIZE: 1000
          MAESTRO_OUTPUT_DIR: maestro-results
          PERFETTO_TRACE_PATH: perfetto-trace.pb
          RN_PERF_JSON_PATH: rn-performance.json
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: |
          node scripts/ci/performance-validation.js

      - name: Validate Memory Budgets
        if: always()
        env:
          BUILD_TYPE: release
          PLATFORM: android
          DEVICE_MODEL: Pixel 6a Emulator
          OS_VERSION: Android 13
          BUILD_HASH: ${{ github.sha }}
          MEMORY_REPORT_PATH: maestro-results/memory-report.json
        run: |
          if [ -f "$MEMORY_REPORT_PATH" ]; then
            node scripts/ci/memory-budget-validator.js "$MEMORY_REPORT_PATH"
          else
            echo "Warning: Memory report not found at $MEMORY_REPORT_PATH"
            echo "Skipping memory budget validation"
          fi

      - name: Collect Performance Artifacts
        if: always()
        env:
          BUILD_HASH: ${{ github.sha }}
          COMMIT: ${{ github.sha }}
          PLATFORM: android
          DEVICE_MODEL: Pixel 6a Emulator
          OS_VERSION: Android 13
          DATASET_SIZE: 1000
          OUTPUT_DIR: performance-artifacts
          PERFETTO_TRACE_PATH: perfetto-trace.pb
          RN_PERF_JSON_PATH: rn-performance.json
          MEMORY_METRICS_PATH: maestro-results/memory-metrics.json
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: |
          pnpm tsx scripts/ci/artifact-collector.ts

      - name: Generate Performance Report
        if: always()
        env:
          BUILD_HASH: ${{ github.sha }}
          COMMIT: ${{ github.sha }}
          PLATFORM: android
          DEVICE_MODEL: Pixel 6a Emulator
          OS_VERSION: Android 13
          DATASET_SIZE: 1000
          OUTPUT_DIR: performance-artifacts
          RN_PERF_JSON_PATH: rn-performance.json
          MEMORY_METRICS_PATH: maestro-results/memory-metrics.json
          PERFETTO_TRACE_PATH: perfetto-trace.pb
        run: |
          pnpm tsx scripts/ci/generate-performance-report.ts

      - name: Upload Performance Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-performance-artifacts
          path: |
            performance-artifacts/
            maestro-results/
            perfetto-trace.pb
            rn-performance.json
          retention-days: 30

      - name: Upload Perfetto Trace to Perfetto UI
        if: always() && hashFiles('perfetto-trace.pb') != ''
        run: |
          echo "Perfetto trace can be viewed at: https://ui.perfetto.dev"
          echo "Upload the file: perfetto-trace.pb"

      - name: Comment PR with Performance Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = { passed: false };

            try {
              if (fs.existsSync('maestro-results/performance-report.json')) {
                report = JSON.parse(fs.readFileSync('maestro-results/performance-report.json', 'utf8'));
              }
            } catch (error) {
              console.error('Failed to read performance report:', error);
            }

            const status = report.passed ? '✅ PASSED' : '❌ FAILED';

            // Safe metric extraction with null coalescing
            const avgFps = report.metrics?.fps?.avgFps ?? null;
            const p95 = report.metrics?.fps?.p95FrameTime ?? null;
            const dropped = report.metrics?.fps?.droppedFramesPct ?? null;
            const memoryDelta = (report.metrics?.memory?.peakRSS != null && report.metrics?.memory?.baselineRSS != null)
              ? report.metrics.memory.peakRSS - report.metrics.memory.baselineRSS
              : null;

            const body = `## Performance Test Results (Android) ${status}

            **Build**: \`${context.sha.substring(0, 7)}\`
            **Platform**: Android (Pixel 6a Emulator)
            **Dataset**: 1000 posts

            ### Metrics

            | Metric | Value | Budget | Status |
            |--------|-------|--------|--------|
            | Avg FPS | ${avgFps ?? 'N/A'} | ≥58 | ${avgFps !== null ? (avgFps >= 58 ? '✅' : '❌') : 'N/A'} |
            | P95 Frame Time | ${p95 ?? 'N/A'} ms | ≤16.7ms | ${p95 !== null ? (p95 <= 16.7 ? '✅' : '❌') : 'N/A'} |
            | Dropped Frames | ${dropped ?? 'N/A'}% | ≤1% | ${dropped !== null ? (dropped <= 1 ? '✅' : '❌') : 'N/A'} |
            | Memory Delta | ${memoryDelta ?? 'N/A'} MB | ≤50MB | ${memoryDelta !== null ? (memoryDelta <= 50 ? '✅' : '❌') : 'N/A'} |

            ### Artifacts

            - [Maestro Results](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - [Perfetto Trace](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) (download and open in [Perfetto UI](https://ui.perfetto.dev))
            - [RN Performance JSON](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ---
            *Performance tests run on release builds only. See [Performance Testing Guide](/docs/performance/image-optimization-visual-qa.md) for manual QA checklist.*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================================================
  # iOS Performance Tests (optional, runs on macOS)
  # ============================================================================
  ios-performance:
    name: iOS Performance Tests
    runs-on: macos-14
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both'
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm-install

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install Maestro
        run: |
          pnpm run install-maestro
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install
          cd ..

      - name: Build iOS Release
        env:
          BUILD_TYPE: release
        run: |
          # Build for simulator (faster than device build)
          xcodebuild -workspace ios/GrowBro.xcworkspace \
            -scheme GrowBro \
            -configuration Release \
            -sdk iphonesimulator \
            -derivedDataPath ios/build

      - name: Start iOS Simulator
        run: |
          xcrun simctl boot "iPhone 12" || true
          sleep 10

      - name: Install App on Simulator
        run: |
          xcrun simctl install booted ios/build/Build/Products/Release-iphonesimulator/GrowBro.app

      - name: Seed Test Database
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          # TODO: Create data seeding script
          echo "Database seeding would happen here"

      - name: Run Maestro Performance Tests
        env:
          APP_ID: com.growbro.app
          BUILD_TYPE: release
          PLATFORM: ios
          DEVICE_MODEL: iPhone 12 Simulator
          OS_VERSION: iOS 17
          BUILD_HASH: ${{ github.sha }}
          DATASET_SIZE: 1000
        run: |
          maestro test .maestro/community/scroll-performance.yaml \
            --format junit \
            --output maestro-results/performance-results.xml

      - name: Run Memory Leak Detection Test
        env:
          APP_ID: com.growbro.app
          BUILD_TYPE: release
          PLATFORM: ios
          DEVICE_MODEL: iPhone 12 Simulator
          OS_VERSION: iOS 17
          BUILD_HASH: ${{ github.sha }}
          DATASET_SIZE: 1000
        run: |
          maestro test .maestro/performance/memory-scroll.yaml \
            --format junit \
            --output maestro-results/memory-test-results.xml

      - name: Collect RN Performance Metrics
        if: always()
        run: |
          # Pull RN performance JSON from iOS simulator
          APP_DATA_PATH=$(xcrun simctl get_app_container booted com.growbro.app data)
          cp "$APP_DATA_PATH/Documents/performance.json" ./rn-performance.json || true

      - name: Validate Performance Budgets
        if: always()
        env:
          BUILD_TYPE: release
          PLATFORM: ios
          DEVICE_MODEL: iPhone 12 Simulator
          OS_VERSION: iOS 17
          BUILD_HASH: ${{ github.sha }}
          DATASET_SIZE: 1000
          MAESTRO_OUTPUT_DIR: maestro-results
          RN_PERF_JSON_PATH: rn-performance.json
        run: |
          node scripts/ci/performance-validation.js

      - name: Collect Performance Artifacts
        if: always()
        env:
          BUILD_HASH: ${{ github.sha }}
          COMMIT: ${{ github.sha }}
          PLATFORM: ios
          DEVICE_MODEL: iPhone 12 Simulator
          OS_VERSION: iOS 17
          DATASET_SIZE: 1000
          OUTPUT_DIR: performance-artifacts
          RN_PERF_JSON_PATH: rn-performance.json
          MEMORY_METRICS_PATH: maestro-results/memory-metrics.json
        run: |
          pnpm tsx scripts/ci/artifact-collector.ts

      - name: Generate Performance Report
        if: always()
        env:
          BUILD_HASH: ${{ github.sha }}
          COMMIT: ${{ github.sha }}
          PLATFORM: ios
          DEVICE_MODEL: iPhone 12 Simulator
          OS_VERSION: iOS 17
          DATASET_SIZE: 1000
          OUTPUT_DIR: performance-artifacts
          RN_PERF_JSON_PATH: rn-performance.json
          MEMORY_METRICS_PATH: maestro-results/memory-metrics.json
        run: |
          pnpm tsx scripts/ci/generate-performance-report.ts

      - name: Upload Performance Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-performance-artifacts
          path: |
            performance-artifacts/
            maestro-results/
            rn-performance.json
          retention-days: 30

      - name: Comment PR with Performance Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = { passed: false };

            try {
              if (fs.existsSync('maestro-results/performance-report.json')) {
                report = JSON.parse(fs.readFileSync('maestro-results/performance-report.json', 'utf8'));
              }
            } catch (error) {
              console.error('Failed to read performance report:', error);
            }

            const status = report.passed ? '✅ PASSED' : '❌ FAILED';

            // Safe metric extraction with null coalescing
            const avgFps = report.metrics?.fps?.avgFps ?? null;
            const p95 = report.metrics?.fps?.p95FrameTime ?? null;
            const dropped = report.metrics?.fps?.droppedFramesPct ?? null;
            const memoryDelta = (report.metrics?.memory?.peakRSS != null && report.metrics?.memory?.baselineRSS != null)
              ? report.metrics.memory.peakRSS - report.metrics.memory.baselineRSS
              : null;

            const body = `## Performance Test Results (iOS) ${status}

            **Build**: \`${context.sha.substring(0, 7)}\`
            **Platform**: iOS (iPhone 12 Simulator)
            **Dataset**: 1000 posts

            ### Metrics

            | Metric | Value | Budget | Status |
            |--------|-------|--------|--------|
            | Avg FPS | ${avgFps ?? 'N/A'} | ≥58 | ${avgFps !== null ? (avgFps >= 58 ? '✅' : '❌') : 'N/A'} |
            | P95 Frame Time | ${p95 ?? 'N/A'} ms | ≤16.7ms | ${p95 !== null ? (p95 <= 16.7 ? '✅' : '❌') : 'N/A'} |
            | Dropped Frames | ${dropped ?? 'N/A'}% | ≤1% | ${dropped !== null ? (dropped <= 1 ? '✅' : '❌') : 'N/A'} |
            | Memory Delta | ${memoryDelta ?? 'N/A'} MB | ≤50MB | ${memoryDelta !== null ? (memoryDelta <= 50 ? '✅' : '❌') : 'N/A'} |

            ### Artifacts

            - [Maestro Results](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - [RN Performance JSON](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ---
            *Performance tests run on release builds only. See [Performance Testing Guide](/docs/performance/image-optimization-visual-qa.md) for manual QA checklist.*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

